SELECT "dbt_jeck_bronze__stg_olist_orders"."ORDER_ID",
    "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP",
    "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT",
    DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT") AS "TIME_TO_APPROVAL_IN_SECONDS",
    "dbt_jeck_bronze__stg_olist_order_payments"."PAYMENT_VALUE",
    CASE
        WHEN 60 * 60 = 0 THEN NULL
        ELSE COALESCE(DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT"), 0) / (60 * 60)
    END AS "TIME_TO_APPROVAL_IN_HOURS",
    CASE
        WHEN CASE
            WHEN 60 * 60 = 0 THEN NULL
            ELSE COALESCE(DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT"), 0) / (60 * 60)
        END <= 0 THEN '0'
        WHEN CASE
            WHEN 60 * 60 = 0 THEN NULL
            ELSE COALESCE(DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT"), 0) / (60 * 60)
        END <= 24 THEN '0-24'
        WHEN CASE
            WHEN 60 * 60 = 0 THEN NULL
            ELSE COALESCE(DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT"), 0) / (60 * 60)
        END <= 48 THEN '24-48'
        WHEN CASE
            WHEN 60 * 60 = 0 THEN NULL
            ELSE COALESCE(DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT"), 0) / (60 * 60)
        END <= 72 THEN '48-72'
        WHEN CASE
            WHEN 60 * 60 = 0 THEN NULL
            ELSE COALESCE(DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT"), 0) / (60 * 60)
        END <= 96 THEN '72-96'
        WHEN CASE
            WHEN 60 * 60 = 0 THEN NULL
            ELSE COALESCE(DATEDIFF(SECOND, "dbt_jeck_bronze__stg_olist_orders"."ORDER_PURCHASE_TIMESTAMP", "dbt_jeck_bronze__stg_olist_orders"."ORDER_APPROVED_AT"), 0) / (60 * 60)
        END > 96 THEN '96+'
        ELSE NULL
    END AS "BIN_TIME_TO_APPROVAL_IN_HOURS"
FROM {{ref('stg_olist_orders')}} AS "dbt_jeck_bronze__stg_olist_orders"
    LEFT JOIN {{ref('stg_olist_order_payments')}} AS "dbt_jeck_bronze__stg_olist_order_payments" ON "dbt_jeck_bronze__stg_olist_orders"."ORDER_ID" = "dbt_jeck_bronze__stg_olist_order_payments"."ORDER_ID"
GROUP BY 5, 7, 3, 1, 2, 6, 4
